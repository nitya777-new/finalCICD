name: CI - Validate & Publish Model

on:
  push:
    branches: [ main ]

jobs:
  validate-and-publish:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      PYTHONUNBUFFERED: 1

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'

      - name: Install apt deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y git-lfs

      - name: Install Python deps (CPU torch + requirements)
        env:
          PIP_DEFAULT_TIMEOUT: 120
        run: |
          python -m pip install --upgrade pip
          python -m pip install torch --index-url https://download.pytorch.org/whl/cpu
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          else
            python -m pip install ultralytics opencv-python-headless mlflow "dvc[s3]" pyyaml
          fi

      - name: Verify installs
        run: |
          python -c "import importlib.util; import torch; print('torch:', torch.__version__)"
          python -c "import dvc; print('dvc: ok')"
          python -c "import mlflow; print('mlflow: ok')"
          python -c "import ultralytics; print('ultralytics: ok')"

      - name: Configure DVC remote (DagsHub)
        env:
          DAGSHUB_REPO: ${{ secrets.DAGSHUB_REPO }}
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          dvc remote remove origin 2>/dev/null || true
          dvc remote add -d origin s3://dvc
          
          REPO="${DAGSHUB_REPO}"
          URL="https://dagshub.com/${REPO}.s3"

          dvc remote modify origin endpointurl "$URL"
          dvc remote modify origin --local access_key_id "${DAGSHUB_TOKEN}"
          dvc remote modify origin --local secret_access_key "${DAGSHUB_TOKEN}"

          echo "=== dvc remote list ==="
          dvc remote list || true
          
          echo "=== .dvc/config.local preview ==="
          if [ -f .dvc/config.local ]; then
            head -n 200 .dvc/config.local || true
          fi

      - name: dvc pull
        run: |
          dvc pull || echo "⚠️ DVC pull failed or no remote data available"

      - name: Run evaluation
        run: |
          if [ -f "data/data.yaml" ] && [ -f "evaluate.py" ] && [ -f "models/best.pt" ]; then
            python evaluate.py --model models/best.pt --data data/data.yaml
          else
            echo "⚠️ Missing required files for evaluation (data/data.yaml, evaluate.py, or models/best.pt)"
            exit 0
          fi

      - name: Upload eval summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eval-summary
          path: eval_summary.json
          if-no-files-found: warn

      - name: dvc push (upload model blobs)
        env:
          DAGSHUB_REPO: ${{ secrets.DAGSHUB_REPO }}
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          if dvc status --cloud | grep -q "new\|modified"; then
            dvc push --jobs 4
          else
            echo "✓ No new data to push"
          fi